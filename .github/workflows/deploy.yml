name: Deploy to AWS

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Read Version
      id: version
      run: |
        if [ -f version.txt ]; then
          echo "APP_VERSION=$(cat version.txt | xargs)" >> $GITHUB_ENV
        else
          echo "APP_VERSION=3.0.0-ci" >> $GITHUB_ENV
        fi

    - name: Install & Build Frontend
      env:
        NEXT_PUBLIC_APP_VERSION: ${{ env.APP_VERSION }}
      run: |
        cd client
        npm ci --legacy-peer-deps
        npm run build

    - name: Prepare Deployment Package
      run: |
        # Create structure
        mkdir -p deploy/client
        mkdir -p deploy/routes
        mkdir -p deploy/data
        mkdir -p deploy/server
        mkdir -p deploy/public
        
        # Copy Backend Root Files
        cp *.js package.json version.txt deploy/
        
        # Copy Backend Folders
        cp -r routes/* deploy/routes/ || true
        cp -r data/* deploy/data/ || true
        cp -r server/* deploy/server/ || true
        cp -r public/* deploy/public/ || true
        
        # Copy Frontend Build Artifacts
        cp -r client/.next deploy/client/
        cp -r client/public deploy/client/
        cp client/package.json deploy/client/
        cp client/next.config.mjs deploy/client/
        
        # Create Version Env for server
        echo "APP_VERSION=${{ env.APP_VERSION }}" > deploy/.version_env

    - name: Zip Artifact
      run: |
        cd deploy
        zip -r ../jukebox_deploy.zip .

    - name: Copy Files to Server (SCP)
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USER }}
        key: ${{ secrets.AWS_KEY }}
        source: "jukebox_deploy.zip"
        target: "/home/ubuntu/jukebox"

    - name: Execute Remote Deployment (SSH)
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.AWS_HOST }}
        username: ${{ secrets.AWS_USER }}
        key: ${{ secrets.AWS_KEY }}
        script: |
          cd /home/ubuntu/jukebox
          
          # 1. Stop Services
          pm2 stop all || true
          
          # 2. Disk Cleanup (WITH SUDO) - Forces clean state
          echo "ðŸ§¹ Cleaning old build artifacts..."
          sudo rm -rf client
          sudo rm -rf node_modules 
          sudo rm -rf routes data server public
          
          # 3. Unzip new code
          unzip -o jukebox_deploy.zip -x .env
          
          # 4. FIX PERMISSIONS (CRITICAL STEP)
          # We force ownership to 'ubuntu' immediately after unzip
          sudo chown -R ubuntu:ubuntu /home/ubuntu/jukebox
          
          # FIX: Force directories to be readable/executable to prevent 'scandir' error
          chmod -R 755 /home/ubuntu/jukebox/client/.next || true
          
          # 5. Update APP_VERSION
          if grep -q 'APP_VERSION=' .env; then
            sed -i 's/^APP_VERSION=.*/APP_VERSION=${{ env.APP_VERSION }}/' .env
          else
            echo "APP_VERSION=${{ env.APP_VERSION }}" >> .env
          fi
          
          # 6. Cleanup Zip
          rm jukebox_deploy.zip .version_env
          
          # 7. Install Backend (Install ALL deps to be safe)
          echo "ðŸ“¦ Installing Backend..."
          npm install --legacy-peer-deps
          
          # 8. Restart Backend
          pm2 delete backend || true
          pm2 start server.js --name "backend"
          
          # 9. Install Frontend (Install ALL deps to include Tailwind)
          echo "ðŸ“¦ Installing Frontend..."
          cd client
          npm install --legacy-peer-deps
          
          # 10. Start Frontend
          pm2 delete frontend || true
          pm2 start npm --name "frontend" -- start
          
          # 11. Save State
          pm2 save